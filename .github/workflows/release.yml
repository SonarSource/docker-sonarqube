name: Release SBOM Assets

on:
  release:
    types:
      - created

jobs:
  release:
    name: Upload Release Asset
    strategy:
      fail-fast: false
      matrix:
        tag:
          - 8-community
          - 8-developer
          - 8-enterprise
          - 8-datacenter-app
          - 8-datacenter-search
          - 9-community
          - 9-developer
          - 9-enterprise
          - 9-datacenter-app
          - 9-datacenter-search
    runs-on: ubuntu-latest
    steps:
      - name: Generate CycloneDX SBOM
        run: |
          curl -sSfL https://raw.githubusercontent.com/docker/sbom-cli-plugin/v0.6.0/install.sh -o install.sh
          md5sum -c <(echo "f4f928096f6e7ea099ad61b0879d221a  install.sh")
          sh ./install.sh v0.6.0 && rm install.sh
          docker-sbom --quiet --format cyclonedx-json --output "sonarqube-${{ matrix.tag }}-bom.json" "sonarqube:${{ matrix.tag }}"
      - name: Sign CycloneDX SBOM
        env:
          GPG_PRIVATE_KEY_BASE64: ${{ secrets.GPG_PRIVATE_KEY_BASE64 }}
          GPG_PRIVATE_KEY_PASSPHRASE: ${{ secrets.GPG_PRIVATE_KEY_PASSPHRASE }}
        run: |
          export GNUPGHOMEDIR=gnupg/
          mkdir --parent "${GNUPGHOMEDIR}"
          echo "${GPG_PRIVATE_KEY_PASSPHRASE}" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --quiet --import <(echo "${GPG_PRIVATE_KEY_BASE64}")
          echo "${GPG_PRIVATE_KEY_PASSPHRASE}" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --quiet --detach-sign --armor "sonarqube-${{ matrix.tag }}-bom.json"
          rm -rf "${GNUPGHOMEDIR}"
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          asset_name: "sonarqube-${{ matrix.tag }}-sbom"
          file: "sonarqube-${{ matrix.tag }}-bom.json*"
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
