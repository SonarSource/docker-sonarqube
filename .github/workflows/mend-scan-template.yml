name: Mend scan template

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
        description: "The image name to scan (e.g., sonarsource/sonarqube or sonarqube)"
      tags:
        required: true
        type: string
        description: "JSON array of tags to scan"
      scan_type:
        required: true
        type: string
        description: "Type of scan (private or public)"
      platform:
        required: false
        type: string
        description: "Platform to scan"
        default: "amd64"
      ws_product_name:
        required: false
        type: string
        description: "WhiteSource product name"
        default: "SonarSource/docker-sonarqube"
      needs_docker_login:
        required: false
        type: boolean
        description: "Whether Docker login is needed"
        default: true

jobs:
  mend-scan:
    name: Mend scan (${{ matrix.tag }})
    runs-on: ubuntu-24.04-large
    strategy:
      matrix:
        tag: ${{ fromJSON(inputs.tags) }}
    
    env:
      IMAGE_NAME: ${{ inputs.image_name }}
      WS_PRODUCTNAME: ${{ inputs.ws_product_name }}
      platform: ${{ inputs.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: secrets
        name: Retrieve secrets from Vault
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/docker/sonardockerrw username | docker_username;
            development/kv/data/docker/sonardockerrw access_token_rwd | docker_password;
            development/kv/data/mend apikey | mend_api_key;

      - name: Login to Docker Hub
        if: ${{ inputs.needs_docker_login }}
        uses: docker/login-action@v3
        with:
          username: ${{ fromJSON(steps.secrets.outputs.vault).docker_username }}
          password: ${{ fromJSON(steps.secrets.outputs.vault).docker_password }}

      - name: Pull Docker image for scanning
        env:
          TAG: ${{ matrix.tag }}
        run: |
          echo "Scan the ${IMAGE_NAME}:${TAG} image supporting linux/${platform}"
          if [[ "${{ inputs.needs_docker_login }}" == "true" ]]; then
            .cirrus/pull.sh "${IMAGE_NAME}" "${TAG}" "${platform}"
          else
            # For public images, use direct docker pull
            docker pull --platform linux/"${platform}" "${IMAGE_NAME}:${TAG}"
          fi

      - name: Set up Java for Mend agent
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Download Mend Unified Agent
        run: |
          wget -O wss-unified-agent.jar https://github.com/whitesource/unified-agent-distribution/releases/latest/download/wss-unified-agent.jar

      - name: Configure Mend scan
        env:
          TAG: ${{ matrix.tag }}
        run: |
          echo "docker.includes=${TAG}" >> .cirrus/wss-unified-agent.config

      - name: Run Mend scan
        env:
          TAG: ${{ matrix.tag }}
          MEND_API_KEY: ${{ fromJSON(steps.secrets.outputs.vault).mend_api_key }}
          WS_WSS_URL: https://saas-eu.whitesourcesoftware.com/agent
        run: |
          java -jar wss-unified-agent.jar \
            -c .cirrus/wss-unified-agent.config \
            -apiKey "${MEND_API_KEY}" \
            -product "${WS_PRODUCTNAME}" \
            -project "${IMAGE_NAME}:${TAG}" \
            -wss.url "${WS_WSS_URL}" \
            -docker.scanImages true
